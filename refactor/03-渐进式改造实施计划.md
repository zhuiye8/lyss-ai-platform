# æ¸è¿›å¼æ”¹é€ å®æ–½è®¡åˆ’

## ğŸ“‹ æ”¹é€ ç­–ç•¥æ¦‚è¿°

é‡‡ç”¨**æ¸è¿›å¼æ”¹é€ **ç­–ç•¥ï¼Œå……åˆ†åˆ©ç”¨ç°æœ‰90%çš„é«˜è´¨é‡åŸºç¡€è®¾æ–½ï¼Œé€šè¿‡ä¸‰ä¸ªé˜¶æ®µçš„ç³»ç»Ÿæ€§æ”¹é€ ï¼Œå®ç°æŠ€æœ¯æ¶æ„å‡çº§å’ŒåŠŸèƒ½å®Œå–„ã€‚

---

## âš–ï¸ é‡å†™ vs æ”¹é€ å†³ç­–

### æˆæœ¬æ•ˆç›Šå¯¹æ¯”

| æ–¹æ¡ˆ | å¼€å‘æ—¶é—´ | äººåŠ›æˆæœ¬ | é£é™©ç­‰çº§ | å·²æœ‰æŠ•èµ„åˆ©ç”¨ç‡ |
|------|----------|----------|----------|----------------|
| **é‡å†™** | 6ä¸ªæœˆ | 150äººå¤© | é«˜ | 0% |
| **æ”¹é€ ** | 3ä¸ªæœˆ | 100äººå¤© | ä½ | 90% |

### æ”¹é€ æ–¹æ¡ˆä¼˜åŠ¿
- **èŠ‚çœ50%å¼€å‘æˆæœ¬** - å……åˆ†åˆ©ç”¨ç°æœ‰æŠ€æœ¯åŸºç¡€
- **æå‰3ä¸ªæœˆäº¤ä»˜** - åŸºäºå·²éªŒè¯çš„æ¶æ„å¿«é€Ÿè¿­ä»£
- **é£é™©å¯æ§** - åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µç‹¬ç«‹éªŒè¯
- **æŠ•èµ„ä¿æŠ¤** - æœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰ä»£ç å’ŒåŸºç¡€è®¾æ–½

---

## ğŸ”„ æœåŠ¡æ¶æ„è°ƒæ•´æ–¹æ¡ˆ

### ç°æœ‰ â†’ æ”¹é€ åæ¶æ„æ˜ å°„

```
ç°æœ‰æ¶æ„                    æ”¹é€ åæ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Gateway   â”‚  ä¿æŒ   â”‚   API Gateway   â”‚
â”‚   (FastAPI)     â”‚  â”€â”€â”€â†’   â”‚   (FastAPI)     â”‚ 
â”‚     8000        â”‚         â”‚     8000        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auth Service   â”‚  ä¿æŒ   â”‚  Auth Service   â”‚
â”‚   (FastAPI)     â”‚  â”€â”€â”€â†’   â”‚   (FastAPI)     â”‚
â”‚     8001        â”‚         â”‚     8001        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tenant Service  â”‚  é‡æ„   â”‚ Tenant Service  â”‚
â”‚   (FastAPI)     â”‚  â”€â”€â”€â†’   â”‚   (FastAPI)     â”‚ (èŒè´£æ”¶ç¼©)
â”‚     8002        â”‚         â”‚     8002        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ—          â”‚  æ–°å¢   â”‚Provider Service â”‚
â”‚                 â”‚  â”€â”€â”€â†’   â”‚   (FastAPI)     â”‚ (One-APIæœºåˆ¶)
â”‚                 â”‚         â”‚     8003        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ—          â”‚  æ–°å¢   â”‚  Chat Service   â”‚
â”‚                 â”‚  â”€â”€â”€â†’   â”‚  (Go + EINO)    â”‚ (æ–°æŠ€æœ¯æ ˆ)
â”‚                 â”‚         â”‚     8004        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ—          â”‚  æ–°å¢   â”‚ Memory Service  â”‚
â”‚                 â”‚  â”€â”€â”€â†’   â”‚ (FastAPI+Mem0)  â”‚ (æ–°åŠŸèƒ½)
â”‚                 â”‚         â”‚     8005        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®åº“è¿ç§»ç­–ç•¥

```sql
-- é˜¶æ®µ1: æ‰©å±•ç°æœ‰è¡¨
ALTER TABLE supplier_credentials ADD COLUMN channel_type INTEGER DEFAULT 1;
ALTER TABLE supplier_credentials ADD COLUMN priority INTEGER DEFAULT 1;
ALTER TABLE supplier_credentials ADD COLUMN weight INTEGER DEFAULT 1;

-- é˜¶æ®µ2: æ–°å¢Channel/Tokenè¡¨
CREATE TABLE provider_channels (
    id SERIAL PRIMARY KEY,
    legacy_credential_id UUID REFERENCES supplier_credentials(id),
    name VARCHAR(100) NOT NULL,
    type INTEGER NOT NULL,
    -- å…¶ä»–One-APIå…¼å®¹å­—æ®µ...
);

-- é˜¶æ®µ3: æ•°æ®è¿ç§»
INSERT INTO provider_channels (legacy_credential_id, name, type, key, ...)
SELECT id, display_name, 1, encrypted_api_key, ...
FROM supplier_credentials;
```

---

## ğŸš€ ä¸‰é˜¶æ®µå®æ–½è®¡åˆ’

## ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„æ”¹é€  (4å‘¨)

### 1.1 æ•°æ®åº“è¿ç§» (1å‘¨)
**ç›®æ ‡**: æ‰©å±•ç°æœ‰æ•°æ®æ¨¡å‹ï¼Œæ”¯æŒæ–°çš„Channel/Tokenæœºåˆ¶

**æ ¸å¿ƒä»»åŠ¡**:
- å¤‡ä»½ç°æœ‰æ•°æ®
- æ‰©å±• `supplier_credentials` è¡¨ï¼Œæ·»åŠ Channelç®¡ç†å­—æ®µ
- åˆ›å»ºæ–°çš„ `provider_channels` å’Œ `user_tokens` è¡¨
- ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬ï¼Œç¡®ä¿å‘åå…¼å®¹

### 1.2 Provider Serviceå¼€å‘ (2å‘¨)
**ç›®æ ‡**: å®ç°One-APIé£æ ¼çš„Channel/Tokenç®¡ç†

**æ ¸å¿ƒå®ç°**:
```python
# provider_service/models.py
class ProviderChannel(BaseModel):
    id: UUID
    name: str                    # æ˜¾ç¤ºåç§°ï¼Œå¦‚"å›¢é˜ŸOpenAI"
    type: int                    # ä¾›åº”å•†ç±»å‹: 1=OpenAI, 2=Anthropic, 3=DeepSeek
    key: str                     # åŠ å¯†çš„APIå¯†é’¥
    
    # One-APIæ ¸å¿ƒæœºåˆ¶
    priority: int = 1            # ä¼˜å…ˆçº§(1-100)
    weight: int = 1              # æƒé‡(è´Ÿè½½å‡è¡¡)
    status: int = 1              # çŠ¶æ€: 1=å¯ç”¨, 2=ç¦ç”¨, 3=é”™è¯¯
    
    # å¤šç§Ÿæˆ·æ”¯æŒ
    config_type: str             # 'personal', 'group'
    user_id: Optional[UUID]      # ä¸ªäººé…ç½®
    group_id: Optional[UUID]     # ç¾¤ç»„é…ç½®
    
    # é…é¢ç®¡ç†
    quota: Optional[int]         # é…é¢é™åˆ¶
    used_quota: int = 0          # å·²ä½¿ç”¨é…é¢

# provider_service/services.py
class ChannelService:
    async def get_available_channels(self, user_id: UUID) -> List[ProviderChannel]:
        """è·å–ç”¨æˆ·å¯ç”¨çš„Channelåˆ—è¡¨"""
        # è·å–ä¸ªäººChannel
        personal_channels = await self.repository.find_by_filter(
            config_type="personal", user_id=user_id, status=1
        )
        
        # è·å–ç¾¤ç»„Channel
        user_groups = await self.get_user_groups(user_id)
        group_channels = []
        for group in user_groups:
            channels = await self.repository.find_by_filter(
                config_type="group", group_id=group.id, status=1
            )
            group_channels.extend(channels)
        
        return personal_channels + group_channels
    
    async def select_channel_by_load_balance(self, channels: List[ProviderChannel]) -> ProviderChannel:
        """åŸºäºæƒé‡å’Œä¼˜å…ˆçº§é€‰æ‹©Channel"""
        # æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œç›¸åŒä¼˜å…ˆçº§æŒ‰æƒé‡é€‰æ‹©
        sorted_channels = sorted(channels, key=lambda ch: (ch.priority, -ch.weight))
        
        # åŠ æƒéšæœºé€‰æ‹©
        weights = [ch.weight for ch in sorted_channels]
        return random.choices(sorted_channels, weights=weights)[0]
```

### 1.3 å‰ç«¯ç•Œé¢é‡æ„ (1å‘¨)
**ç›®æ ‡**: è§£å†³AdminLayoutå†—ä½™å¤´åƒé—®é¢˜ï¼Œä¼˜åŒ–ç•Œé¢æ¶æ„

**é‡æ„æ–¹æ¡ˆ**:
```tsx
// frontend/src/components/layout/AdminLayout.tsx
const AdminLayout: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  return (
    <Layout style={{ height: '100vh' }}>
      {/* é¡¶éƒ¨èœå•æ  - åªä¿ç•™ä¸€ä¸ªç”¨æˆ·å¤´åƒåœ¨å³ä¸Šè§’ */}
      <Header style={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        padding: '0 24px',
        background: '#fff'
      }}>
        <div style={{ fontSize: '18px', fontWeight: 'bold' }}>
          Lyss AI Platform
        </div>
        
        {/* ç”¨æˆ·èœå• - ç§»é™¤å†—ä½™å¤´åƒï¼Œåªä¿ç•™è¿™ä¸€ä¸ª */}
        <Dropdown menu={{ items: userMenuItems }}>
          <Avatar style={{ cursor: 'pointer' }} icon={<UserOutlined />} />
        </Dropdown>
      </Header>

      <Layout>
        {/* å·¦ä¾§å¯¹è¯å†å²ä¾§è¾¹æ  */}
        <Sider width={280} style={{ background: '#fafafa' }} collapsible>
          <ConversationHistory />
        </Sider>

        {/* ä¸»å¯¹è¯åŒºåŸŸ - ç§»é™¤å†…å®¹é¡µå†—ä½™æ ‡å¤´ */}
        <Content style={{ padding: 0, background: '#fff' }}>
          {children}
        </Content>
      </Layout>
    </Layout>
  );
};
```

---

## ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½é›†æˆ (4å‘¨)

### 2.1 Memory Serviceå¼€å‘ (1.5å‘¨)
**ç›®æ ‡**: é›†æˆMem0AIï¼Œå®ç°æ™ºèƒ½è®°å¿†ç®¡ç†

```python
# memory_service/services.py
class MemoryService:
    def __init__(self):
        self.mem0 = Memory(config={
            "vector_store": {
                "provider": "qdrant",
                "config": {"host": "qdrant", "port": 6333}
            }
        })
    
    async def add_conversation_memory(self, user_id: str, conversation_id: str, 
                                    message: str, role: str = "user") -> dict:
        """æ·»åŠ å¯¹è¯è®°å¿†"""
        metadata = {
            "conversation_id": conversation_id,
            "role": role,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        # ä½¿ç”¨Mem0AIæ·»åŠ è®°å¿†
        result = self.mem0.add(message, user_id=user_id, metadata=metadata)
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        memory_record = ConversationMemory(
            user_id=user_id,
            conversation_id=conversation_id,
            memory_content=message,
            memory_hash=result.get('id'),
            memory_type="conversation"
        )
        
        await self.repository.create(memory_record)
        return result
    
    async def enhance_prompt_with_memory(self, user_id: str, current_message: str) -> str:
        """ä½¿ç”¨è®°å¿†å¢å¼ºæç¤ºè¯"""
        relevant_memories = await self.get_relevant_memories(
            user_id=user_id, query=current_message, limit=3
        )
        
        if not relevant_memories:
            return current_message
        
        memory_context = "\n".join([f"- {mem['content']}" for mem in relevant_memories])
        
        enhanced_prompt = f"""
åŸºäºä»¥ä¸‹å†å²è®°å¿†ä¸Šä¸‹æ–‡å›ç­”ç”¨æˆ·é—®é¢˜ï¼š

**ç›¸å…³è®°å¿†**:
{memory_context}

**å½“å‰é—®é¢˜**: {current_message}

è¯·ç»“åˆè®°å¿†ä¸Šä¸‹æ–‡ç»™å‡ºä¸ªæ€§åŒ–çš„å›ç­”ã€‚
"""
        return enhanced_prompt
```

### 2.2 Chat Serviceå¼€å‘ (2å‘¨)
**ç›®æ ‡**: é›†æˆEINOæ¡†æ¶ï¼Œå®ç°AIå¯¹è¯åŠŸèƒ½

```go
// chat_service/main.go
type ChatService struct {
    providerClient *ProviderClient
    memoryClient   *MemoryClient
}

type StreamEvent struct {
    Event     string                 `json:"event"`
    TaskID    string                 `json:"task_id"`
    Data      map[string]interface{} `json:"data"`
    CreatedAt string                 `json:"created_at"`
}

func (s *ChatService) ProcessMessage(ctx context.Context, req *ChatRequest) (<-chan StreamEvent, error) {
    eventChan := make(chan StreamEvent, 100)
    
    go func() {
        defer close(eventChan)
        
        // å‘é€å¼€å§‹äº‹ä»¶
        eventChan <- StreamEvent{
            Event: "conversation_started",
            TaskID: req.ConversationID,
            Data: map[string]interface{}{
                "conversation_id": req.ConversationID,
                "user_id": req.UserID,
            },
        }
        
        // ä»Provider Serviceè·å–æ¨¡å‹é…ç½®
        modelConfig, err := s.providerClient.GetModelByToken(req.UserToken, req.ModelName)
        if err != nil {
            eventChan <- StreamEvent{
                Event: "error",
                Data: map[string]interface{}{"error": err.Error()},
            }
            return
        }
        
        // ä½¿ç”¨Memory Serviceå¢å¼ºæç¤ºè¯
        enhancedPrompt, err := s.memoryClient.EnhancePrompt(req.UserID, req.Message)
        if err != nil {
            log.Printf("Memory enhancement failed: %v", err)
            enhancedPrompt = req.Message
        }
        
        // åˆ›å»ºEINO Chain
        chatModel := model.NewChatModel(modelConfig)
        chain, err := compose.NewChain[map[string]any, string]().
            AppendChatTemplate(enhancedPrompt).
            AppendChatModel(chatModel).
            Compile(ctx)
        
        if err != nil {
            eventChan <- StreamEvent{
                Event: "error",
                Data: map[string]interface{}{"error": err.Error()},
            }
            return
        }
        
        // æµå¼å¤„ç†
        streamChan, err := chain.Stream(ctx, map[string]any{"query": enhancedPrompt})
        
        var fullResponse string
        for chunk := range streamChan {
            eventChan <- StreamEvent{
                Event: "message_delta",
                TaskID: req.ConversationID,
                Data: map[string]interface{}{
                    "content": chunk.Content,
                    "delta": chunk.Delta,
                },
            }
            fullResponse += chunk.Delta
        }
        
        // ä¿å­˜å¯¹è¯è®°å¿†
        go func() {
            s.memoryClient.AddMemory(req.UserID, req.ConversationID, req.Message, "user")
            s.memoryClient.AddMemory(req.UserID, req.ConversationID, fullResponse, "assistant")
        }()
        
        // å‘é€å®Œæˆäº‹ä»¶
        eventChan <- StreamEvent{
            Event: "conversation_completed",
            TaskID: req.ConversationID,
            Data: map[string]interface{}{"final_answer": fullResponse},
        }
    }()
    
    return eventChan, nil
}
```

### 2.3 æµå¼å“åº”é›†æˆ (0.5å‘¨)
**ç›®æ ‡**: åœ¨API Gatewayä¸­é›†æˆæµå¼ä»£ç†

```python
# backend/api_gateway/chat.py
@router.post("/stream")
async def stream_chat(request: ChatRequest):
    """æµå¼å¯¹è¯æ¥å£"""
    
    async def generate():
        # ä»£ç†åˆ°Chat Service
        async with httpx.AsyncClient() as client:
            async with client.stream(
                "POST",
                f"{CHAT_SERVICE_URL}/chat/stream",
                json=request.dict()
            ) as response:
                async for chunk in response.aiter_lines():
                    if chunk.startswith("data: "):
                        yield f"{chunk}\n\n"
    
    return StreamingResponse(
        generate(),
        media_type="text/event-stream",
        headers={"Cache-Control": "no-cache", "Connection": "keep-alive"}
    )
```

---

## ç¬¬ä¸‰é˜¶æ®µï¼šåŠŸèƒ½å®Œå–„ (4å‘¨)

### 3.1 å¯¹è¯å†å²ç®¡ç† (1.5å‘¨)

```tsx
// frontend/src/components/chat/ConversationHistory.tsx
const ConversationHistory: React.FC = () => {
  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [searchText, setSearchText] = useState('');

  const loadConversations = async () => {
    const response = await fetch('/api/v1/conversations');
    const data = await response.json();
    setConversations(data.conversations);
  };

  const filteredConversations = conversations.filter(conv =>
    conv.title.toLowerCase().includes(searchText.toLowerCase()) ||
    conv.lastMessage.toLowerCase().includes(searchText.toLowerCase())
  );

  return (
    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      <div style={{ padding: '16px' }}>
        <Input.Search
          placeholder="æœç´¢å¯¹è¯..."
          value={searchText}
          onChange={(e) => setSearchText(e.target.value)}
        />
        <Button type="primary" block icon={<MessageOutlined />}>
          æ–°å»ºå¯¹è¯
        </Button>
      </div>

      <div style={{ flex: 1, overflow: 'auto' }}>
        <List
          dataSource={filteredConversations}
          renderItem={(conversation) => (
            <List.Item style={{ padding: '12px 16px', cursor: 'pointer' }}>
              <List.Item.Meta
                title={conversation.title}
                description={
                  <div>
                    <div style={{ fontSize: '12px', color: '#666' }}>
                      {conversation.lastMessage}
                    </div>
                    <div style={{ fontSize: '11px', color: '#999' }}>
                      {conversation.messageCount} æ¡æ¶ˆæ¯ Â· {conversation.updatedAt}
                    </div>
                  </div>
                }
              />
            </List.Item>
          )}
        />
      </div>
    </div>
  );
};
```

### 3.2 æ™ºèƒ½è®°å¿†åŠŸèƒ½ (1å‘¨)

```python
# memory_service/advanced_memory.py
class AdvancedMemoryService:
    async def generate_conversation_summary(self, conversation_id: str) -> str:
        """ç”Ÿæˆå¯¹è¯æ€»ç»“"""
        messages = await self.get_conversation_messages(conversation_id)
        
        conversation_text = "\n".join([
            f"{msg.role}: {msg.content}" for msg in messages
        ])
        
        summary_prompt = f"""
è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„å…³é”®ä¿¡æ¯ï¼š
{conversation_text}

è¯·æå–å‡ºï¼š
1. ä¸»è¦è®¨è®ºçš„è¯é¢˜
2. ç”¨æˆ·çš„éœ€æ±‚æˆ–é—®é¢˜  
3. é‡è¦çš„ç»“è®ºæˆ–å»ºè®®
4. éœ€è¦è®°ä½çš„ä¸ªäººåå¥½
"""
        
        summary = await self.llm_client.generate(summary_prompt)
        
        # ä¿å­˜æ€»ç»“ä½œä¸ºè®°å¿†
        await self.add_conversation_memory(
            user_id=messages[0].user_id,
            conversation_id=conversation_id,
            message=summary,
            metadata={"type": "summary", "source": "auto_generated"}
        )
        
        return summary
```

### 3.3 æµ‹è¯•å’Œè´¨é‡ä¿éšœ (1å‘¨)

```python
# tests/test_provider_service.py
class TestChannelManagement:
    def test_create_channel(self):
        """æµ‹è¯•åˆ›å»ºChannel"""
        channel_data = {
            "name": "æµ‹è¯•OpenAI",
            "type": 1,
            "api_key": "sk-test-key"
        }
        
        response = client.post("/channels", json=channel_data)
        assert response.status_code == 201
        assert response.json()["name"] == "æµ‹è¯•OpenAI"
    
    def test_channel_load_balancing(self):
        """æµ‹è¯•Channelè´Ÿè½½å‡è¡¡"""
        # åˆ›å»ºå¤šä¸ªç›¸åŒç±»å‹çš„Channel
        for i in range(3):
            channel_data = {
                "name": f"OpenAI-{i}",
                "type": 1,
                "priority": i + 1,
                "weight": (i + 1) * 10
            }
            client.post("/channels", json=channel_data)
        
        # æµ‹è¯•è´Ÿè½½å‡è¡¡é€‰æ‹©
        for _ in range(10):
            response = client.post("/channels/select", json={"type": 1})
            assert response.status_code == 200
```

### 3.4 ç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ– (0.5å‘¨)

```python
# shared/monitoring.py
from prometheus_client import Counter, Histogram

REQUEST_COUNT = Counter('http_requests_total', 'Total HTTP requests')
REQUEST_DURATION = Histogram('http_request_duration_seconds', 'Request duration')

def monitor_performance(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = await func(*args, **kwargs)
            REQUEST_COUNT.inc()
            return result
        finally:
            REQUEST_DURATION.observe(time.time() - start_time)
    return wrapper
```

---

## ğŸ“Š å®æ–½æˆæœé¢„æœŸ

### æŠ€æœ¯æŒ‡æ ‡
- **æµ‹è¯•è¦†ç›–ç‡**: ä»3.8%æå‡åˆ°80%+
- **APIå“åº”æ—¶é—´**: å¹³å‡<200msï¼Œ95%è¯·æ±‚<500ms
- **å¹¶å‘å¤„ç†**: æ”¯æŒ1000+å¹¶å‘ç”¨æˆ·
- **ç³»ç»Ÿå¯ç”¨æ€§**: 99.5%+

### åŠŸèƒ½äº¤ä»˜
- **å®Œæ•´çš„Channel/Tokenç®¡ç†** - One-APIå…¼å®¹æœºåˆ¶
- **æ™ºèƒ½å¯¹è¯åŠŸèƒ½** - EINOæ¡†æ¶ + æµå¼å“åº”
- **ä¸ªæ€§åŒ–è®°å¿†** - Mem0AIæ™ºèƒ½è®°å¿†ç®¡ç†
- **ç°ä»£åŒ–ç•Œé¢** - è§£å†³ç•Œé¢æ¶æ„é—®é¢˜

### ä¸šåŠ¡ä»·å€¼
- **å¿«é€Ÿäº¤ä»˜** - 3ä¸ªæœˆå†…å®Œæˆæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- **æˆæœ¬èŠ‚çº¦** - ç›¸æ¯”é‡å†™èŠ‚çœ50%å¼€å‘æˆæœ¬
- **æŠ€æœ¯å…ˆè¿›** - é›†æˆä¸šç•Œæœ€ä½³å®è·µ
- **ç”¨æˆ·ä½“éªŒ** - æµç•…çš„AIå¯¹è¯ä½“éªŒ

è¿™ä¸ªæ¸è¿›å¼æ”¹é€ æ–¹æ¡ˆå……åˆ†åˆ©ç”¨ç°æœ‰æŠ•èµ„ï¼Œå¿«é€Ÿå®ç°æŠ€æœ¯å‡çº§ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æŠ€æœ¯å…ˆè¿›çš„AIå¹³å°ã€‚