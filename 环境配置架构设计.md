# 环境配置架构设计

## 🎯 设计原则

### 1. **统一配置源**
- 所有服务使用**根目录的 `.env` 文件**作为唯一配置源
- 避免配置文件重复和不一致问题

### 2. **配置分层管理**
- **全局配置**: 基础设施（数据库、Redis、安全）
- **服务配置**: 各微服务的专用配置
- **开发工具配置**: 开发环境辅助工具

### 3. **AI服务配置策略**
- **系统级AI配置**: 仅用于Mem0AI等基础AI服务
- **用户级AI配置**: 存储在数据库中，支持多租户

## 📋 配置分类

### A. 基础设施配置（所有服务共享）
```bash
# 应用基础
SECRET_KEY=xxx
ENVIRONMENT=development
DEBUG=true

# 数据库
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=xxx
DB_PASSWORD=xxx
DB_DATABASE=xxx

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=xxx
```

### B. 系统级AI配置（仅用于基础AI服务）
```bash
# 仅用于Mem0AI、embedding等系统级AI功能
OPENAI_API_KEY=xxx  # Mem0AI默认需要
OPENAI_BASE_URL=https://api.openai.com/v1
```

### C. 服务专用配置
```bash
# Memory服务
MEMORY_HOST=localhost
MEMORY_PORT=8001
VECTOR_DB_PROVIDER=redis
EMBEDDING_PROVIDER=sentence-transformers
EMBEDDING_MODEL=all-MiniLM-L6-v2

# EINO服务
EINO_HOST=localhost
EINO_PORT=8080
EINO_TIMEOUT=60

# 前端
VITE_API_URL=http://localhost:8000
```

## 🚫 需要移除的配置

### 移除用户级AI配置
```bash
# 这些应该存储在数据库中，不应该在环境变量中
# ANTHROPIC_API_KEY=xxx  # 移除
# GOOGLE_API_KEY=xxx     # 移除
# AI_DEFAULT_PROVIDER=xxx # 移除
```

## 🔄 配置加载策略

### 1. Backend服务
- 从根目录 `../env` 加载配置
- 后端配置类统一管理

### 2. Memory服务
- 从根目录 `../env` 加载配置
- 重写memory服务配置以符合Mem0AI标准

### 3. EINO服务
- 从根目录 `../env` 加载配置
- Go配置管理

### 4. 前端
- 从根目录 `.env` 加载配置
- Vite自动处理VITE_前缀的变量

## 📊 数据库存储的AI配置

### ai_credentials表结构
```sql
CREATE TABLE ai_credentials (
    credential_id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,
    provider_name VARCHAR(50) NOT NULL,  -- openai, anthropic, google
    api_key TEXT NOT NULL,               -- 加密存储
    api_base_url TEXT,
    model_configs JSONB,                 -- 模型配置
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### ai_models表结构
```sql
CREATE TABLE ai_models (
    model_id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,
    credential_id UUID REFERENCES ai_credentials(credential_id),
    model_name VARCHAR(100) NOT NULL,
    display_name VARCHAR(200),
    model_type VARCHAR(50),              -- chat, completion, embedding
    max_tokens INTEGER,
    cost_per_1k_tokens DECIMAL(10,6),
    is_available BOOLEAN DEFAULT true
);
```

## 🔧 实施步骤

1. **清理环境配置**
   - 删除重复的.env文件
   - 重构根目录.env文件

2. **更新配置类**
   - 修改backend配置加载路径
   - 重写memory服务配置符合Mem0AI标准
   - 更新EINO服务配置

3. **数据库AI配置**
   - 实现AI凭证管理API
   - 实现模型配置管理
   - 支持多租户AI配置

4. **移除硬编码AI配置**
   - 从环境变量中移除用户级AI配置
   - 实现动态AI配置加载

## ✅ 预期效果

1. **配置统一**: 所有服务从单一配置源加载
2. **安全性**: 用户AI密钥存储在数据库中，加密存储
3. **多租户**: 支持每个租户配置不同的AI服务商
4. **灵活性**: 管理员可以动态管理AI服务配置
5. **合规性**: 符合Mem0AI等第三方服务的官方配置标准