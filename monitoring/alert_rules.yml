# Prometheus 告警规则 - Lyss AI Platform
# 定义系统监控和告警规则

groups:
- name: lyss_platform_alerts
  rules:
  
  # 服务可用性告警
  - alert: 服务下线
    expr: up == 0
    for: 1m
    labels:
      severity: critical
      team: platform
    annotations:
      summary: "服务 {{ $labels.job }} 已下线"
      description: "服务 {{ $labels.job }} 在实例 {{ $labels.instance }} 上已下线超过1分钟"
      runbook_url: "https://docs.lyss.ai/runbooks/service-down"

  # API 延迟告警
  - alert: API延迟过高
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
    for: 5m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "API延迟过高"
      description: "{{ $labels.endpoint }} 的95%延迟为 {{ $value }}秒，超过500ms阈值"
      
  - alert: API延迟严重过高
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2.0
    for: 2m
    labels:
      severity: critical
      team: backend
    annotations:
      summary: "API延迟严重过高"
      description: "{{ $labels.endpoint }} 的95%延迟为 {{ $value }}秒，超过2秒阈值"

  # 错误率告警
  - alert: API错误率过高
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.01
    for: 2m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "API错误率过高"
      description: "{{ $labels.endpoint }} 的错误率为 {{ $value | humanizePercentage }}，超过1%"
      
  - alert: API错误率严重过高
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
    for: 1m
    labels:
      severity: critical
      team: backend
    annotations:
      summary: "API错误率严重过高" 
      description: "{{ $labels.endpoint }} 的错误率为 {{ $value | humanizePercentage }}，超过5%"

  # 数据库连接告警
  - alert: 数据库连接数过高
    expr: active_connections > 80
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "数据库连接数过高"
      description: "数据库 {{ $labels.database }} 的活跃连接数为 {{ $value }}，接近上限"
      
  - alert: 数据库连接失败
    expr: increase(database_connection_errors_total[5m]) > 10
    for: 1m
    labels:
      severity: critical
      team: infrastructure
    annotations:
      summary: "数据库连接失败"
      description: "数据库连接在过去5分钟内失败 {{ $value }} 次"

  # 内存使用率告警
  - alert: 内存使用率过高
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.85
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "内存使用率过高"
      description: "节点 {{ $labels.instance }} 的内存使用率为 {{ $value | humanizePercentage }}"
      
  - alert: 内存使用率严重过高
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.95
    for: 2m
    labels:
      severity: critical
      team: infrastructure
    annotations:
      summary: "内存使用率严重过高"
      description: "节点 {{ $labels.instance }} 的内存使用率为 {{ $value | humanizePercentage }}，接近100%"

  # CPU 使用率告警
  - alert: CPU使用率过高
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "CPU使用率过高"
      description: "节点 {{ $labels.instance }} 的CPU使用率为 {{ $value }}%"
      
  - alert: CPU使用率严重过高
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
    for: 2m
    labels:
      severity: critical
      team: infrastructure
    annotations:
      summary: "CPU使用率严重过高"
      description: "节点 {{ $labels.instance }} 的CPU使用率为 {{ $value }}%，接近100%"

  # 磁盘空间告警
  - alert: 磁盘空间不足
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "磁盘空间不足"
      description: "节点 {{ $labels.instance }} 的 {{ $labels.mountpoint }} 磁盘可用空间少于10%"
      
  - alert: 磁盘空间严重不足
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.05
    for: 1m
    labels:
      severity: critical
      team: infrastructure
    annotations:
      summary: "磁盘空间严重不足"
      description: "节点 {{ $labels.instance }} 的 {{ $labels.mountpoint }} 磁盘可用空间少于5%"

  # Redis 告警
  - alert: Redis连接数过高
    expr: redis_connected_clients / redis_config_maxclients > 0.8
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "Redis连接数过高"
      description: "Redis实例 {{ $labels.instance }} 的连接数占最大连接数的 {{ $value | humanizePercentage }}"
      
  - alert: Redis内存使用率过高
    expr: redis_memory_used_bytes / redis_config_maxmemory > 0.9
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "Redis内存使用率过高"
      description: "Redis实例 {{ $labels.instance }} 的内存使用率为 {{ $value | humanizePercentage }}"

  # AI模型调用告警
  - alert: AI模型调用失败率过高
    expr: rate(ai_model_requests_total{status="error"}[5m]) / rate(ai_model_requests_total[5m]) > 0.1
    for: 2m
    labels:
      severity: warning
      team: ai_services
    annotations:
      summary: "AI模型调用失败率过高"
      description: "{{ $labels.provider }}/{{ $labels.model }} 的失败率为 {{ $value | humanizePercentage }}"
      
  - alert: AI模型响应延迟过高
    expr: histogram_quantile(0.95, rate(ai_model_latency_seconds_bucket[5m])) > 30
    for: 5m
    labels:
      severity: warning
      team: ai_services
    annotations:
      summary: "AI模型响应延迟过高"
      description: "{{ $labels.provider }}/{{ $labels.model }} 的95%延迟为 {{ $value }}秒"

  # 租户配额告警
  - alert: 租户API配额即将耗尽
    expr: (tenant_api_calls_used / tenant_api_calls_limit) > 0.9
    for: 10m
    labels:
      severity: warning
      team: platform
    annotations:
      summary: "租户API配额即将耗尽"
      description: "租户 {{ $labels.tenant_id }} 的API调用配额使用率为 {{ $value | humanizePercentage }}"
      
  - alert: 租户配额超限
    expr: rate(http_requests_total{status="429"}[5m]) > 0
    for: 1m
    labels:
      severity: warning
      team: platform
    annotations:
      summary: "租户配额超限"
      description: "租户 {{ $labels.tenant_id }} 正在触发速率限制"

  # 工作流执行告警
  - alert: 工作流执行失败率过高
    expr: rate(workflow_executions_total{status="failed"}[5m]) / rate(workflow_executions_total[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
      team: eino_service
    annotations:
      summary: "工作流执行失败率过高"
      description: "工作流 {{ $labels.workflow_type }} 的失败率为 {{ $value | humanizePercentage }}"
      
  - alert: 工作流执行队列堆积
    expr: workflow_queue_size > 100
    for: 5m
    labels:
      severity: warning
      team: eino_service
    annotations:
      summary: "工作流执行队列堆积"
      description: "工作流执行队列当前有 {{ $value }} 个待处理任务"

  # 记忆服务告警
  - alert: 记忆服务响应延迟过高
    expr: histogram_quantile(0.95, rate(memory_operation_duration_seconds_bucket[5m])) > 1.0
    for: 5m
    labels:
      severity: warning
      team: memory_service
    annotations:
      summary: "记忆服务响应延迟过高"
      description: "记忆服务操作的95%延迟为 {{ $value }}秒"
      
  - alert: 记忆服务错误率过高
    expr: rate(memory_operations_total{status="error"}[5m]) / rate(memory_operations_total[5m]) > 0.05
    for: 2m
    labels:
      severity: warning
      team: memory_service
    annotations:
      summary: "记忆服务错误率过高"
      description: "记忆服务的错误率为 {{ $value | humanizePercentage }}"